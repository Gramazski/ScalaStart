/**
 * Created by gs on 19.04.2017.
 */
var webApp = angular.module('webApp', ["ngRoute"]).config(function ($routeProvider) {
    $routeProvider.when('/',
        {
            templateUrl: 'views/components/home/view.html',
            controller: 'homeController'
        });
    $routeProvider.when('/login',
        {
            templateUrl: 'views/components/login/view.html',
            controller: 'loginController'
        });

    $routeProvider.otherwise({redirectTo: '/'});

}).run(function($rootScope, $location) {
    $rootScope.loggedInUser = false;

    $rootScope.$on( "$routeChangeStart", function(event, next, current) {
        if ($rootScope.loggedInUser === false) {
            if (!((next.templateUrl == "views/components/home/view.html") || (next.templateUrl == "views/components/login/view.html"))) {
                $location.path("/");
            }
        }
        else {
            if (next.templateUrl == "ui/components/login/view.html") {
                $location.path("/");
            }
        }
    });
});
/**
 * Created by gs on 19.04.2017.
 */
webApp.controller("homeController",['$scope', function ($scope) {

}]);
/**
 * Created by gs on 19.04.2017.
 */
webApp.controller("loginController",['$scope', '$rootScope', '$location', 'loginService', function ($scope, $rootScope, $location, loginService) {
    $scope.loginUser = function () {
        var promiseObj = loginService.doLogin($scope.username, $scope.password);
        promiseObj.then(function(value) {
            if (value.id == -1){
                $scope.username = "";
                $scope.password = "";
            }
            else {
                $rootScope.userInfo = value;
                $rootScope.loggedInUser = true;
                $location.path('/');
            }
        });
    }
}]);


/**
 * Created by gs on 19.04.2017.
 */
webApp.factory('loginService',['$http', '$q', function ($http, $q) {
    return{
        doLogin: function (username, password) {
            var deferred = $q.defer();
            $http({
                method: 'POST',
                url: '/login',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8'
                },
                data: 'username=' + username + '&password=' + password
            }).
            then(function(response) {
                    deferred.resolve(response.data);
                },
                function(response) {
                    deferred.reject(response.status);
                });

            return deferred.promise;
        }
    }
}]);


/**
 * Created by gs on 19.04.2017.
 */
webApp.controller("menuController",['$scope', '$rootScope', '$location', 'logoutService', function ($scope, $rootScope, $location, logoutService) {
    $scope.logoutUser = function () {
        var promiseObj = logoutService.doLogout();
        promiseObj.then(function(value) {
            $rootScope.loggedInUser = false;
            $location.path('/');
        });
    }
}]);


/**
 * Created by gs on 19.04.2017.
 */
webApp.factory('logoutService',['$http', '$q', function ($http, $q) {
    return{
        doLogout: function () {
            var deferred = $q.defer();
            $http({
                method: 'POST',
                url: '/logout',
                headers: {
                    'Content-Type': 'json'
                }
            }).
            then(function(response) {
                    deferred.resolve(response.data);
                },
                function(response) {
                    deferred.reject(response.status);
                });

            return deferred.promise;
        }
    }
}]);

